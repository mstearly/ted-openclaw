# SDD 80: P1-3 Residual Vulnerability Decision Package

**Status:** Approved and Executed
**Version:** v1
**Date:** 2026-02-25
**Source Plan:** SDD 78 Wave A, P1-3 closeout
**Scope:** Final decision package for remaining dependency advisories after critical/high remediation

---

## 1. Current Security Posture

Current `pnpm audit --json` summary:

1. `critical: 0`
2. `high: 0`
3. `moderate: 2`
4. `low: 1`

Residual advisories:

| Advisory                        | Severity | Dependency path                                                                            | Patch status                               |
| ------------------------------- | -------- | ------------------------------------------------------------------------------------------ | ------------------------------------------ |
| GHSA-p8p7-x288-28g6 (`request`) | Moderate | `extensions/matrix -> @vector-im/matrix-bot-sdk -> request`                                | No patched version available for `request` |
| GHSA-2g4f-4pwh-qvx6 (`ajv`)     | Moderate | `extensions/matrix -> @vector-im/matrix-bot-sdk -> request -> har-validator -> ajv@6.12.6` | Patched at `ajv >= 6.14.0`                 |
| GHSA-gq3j-xvxp-8hrf (`hono`)    | Low      | root `@buape/carbon` transitive                                                            | Carbon update is policy-blocked            |

---

## 2. Decision Options

### Option A: Apply targeted `ajv` override now

1. Add `pnpm.overrides` entry for `ajv@6: 6.14.0`.
2. Regenerate lockfile.
3. Re-run sidecar and matrix test lanes.
4. Keep `request` and `hono` as accepted residual risks.

Pros:

1. Removes one moderate advisory with available fix path.
2. Minimal blast radius versus broader dependency changes.

Cons:

1. Requires explicit approval because this is a dependency override policy decision.

### Option B: Risk accept all residual advisories now

1. Record owner, rationale, and revisit date.
2. Continue feature execution and revisit when upstreams move.

Pros:

1. Zero code churn.
2. No dependency policy exception needed.

Cons:

1. Leaves known `ajv` advisory unresolved despite available patch.

### Option C: Replace Matrix SDK path

1. Migrate off `@vector-im/matrix-bot-sdk` stack that still depends on `request`.

Pros:

1. Potentially removes both `request` and `ajv` advisories.

Cons:

1. Highest migration risk and effort.
2. Out of scope for immediate P1 wave.

---

## 3. Council Recommendation

Recommended path: **Option A (targeted `ajv` override) + risk accept `request` and `hono` for now**.

Rationale:

1. `ajv` has a direct patch path and can be reduced immediately.
2. `request` has no patch path in current upstream chain.
3. `hono` is blocked by explicit Carbon freeze policy.

---

## 4. Required Operator Decision

Decision needed:

1. Approve or reject targeted override of `ajv@6` to `6.14.0`.

If approved, execute:

1. Add override.
2. Refresh lockfile.
3. Re-run:
   - `npx vitest run --config vitest.sidecar.config.ts`
   - `pnpm --dir extensions/matrix why ajv`
   - `pnpm audit --json`
4. Record updated advisory posture in this SDD and SDD 79.

If rejected:

1. Keep full residual risk acceptance and record revisit target date.

---

## 6. Execution Result (2026-02-25)

Decision outcome: **Approved and applied**.

Implemented:

1. Added root override: `pnpm.overrides["ajv@6"] = "6.14.0"`.
2. Refreshed lockfile with `pnpm install`.

Verification:

1. `pnpm --dir extensions/matrix why ajv` now shows `ajv 6.14.0` on the matrix transitive path.
2. Sidecar suite: `1434/1434` tests passing.
3. Matrix suite: `16/16` tests passing.
4. Audit summary now:
   - `critical: 0`
   - `high: 0`
   - `moderate: 1`
   - `low: 1`

Remaining advisories after decision:

1. `request` (moderate) via matrix SDK transitive chain (no upstream patch currently available).
2. `hono` (low) via Carbon transitive chain (Carbon dependency update policy-blocked).

---

## 5. Residual Risk Record (if no override approved)

| Advisory                | Owner              | Rationale                                        | Review date |
| ----------------------- | ------------------ | ------------------------------------------------ | ----------- |
| `request` SSRF          | Council + Operator | No upstream patched release in current SDK chain | 2026-03-31  |
| `ajv` ReDoS (v6 path)   | Council + Operator | Override not approved                            | 2026-03-31  |
| `hono` timing-hardening | Council + Operator | Carbon dependency is policy-frozen               | 2026-03-31  |
